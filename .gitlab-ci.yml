image: node:latest

stages:
  - Prepare
  - Test build methods
  - Build
  - Deploy

cache:
  paths:
    - node_modules
    
npm_install:
  stage: Prepare
  script:
    - npm install --progress=false

build_tailwind: 
  stage: Test build methods
  script: 
    - npm run tailwind
  except:
    - tags

build_postcss: 
  stage: Test build methods
  script: 
    - npm run postcss-prod
  except:
    - tags

build_parcel: 
  stage: Test build methods
  script: 
    - npm run parcel
  except:
    - tags

build_webpack: 
  stage: Test build methods
  script: 
    - npm run webpack
  except:
    - tags

build: 
  stage: Build
  script: 
    - npm run parcel
  artifacts:
    expire_in: 1 day
    paths: 
      - dist
  only:
   - tags

deploy:
  stage: Deploy
  script:
    - apt-get update -qq && apt-get install -y -qq sshpass
    - sshpass -V
    - export SSHPASS=$PROD_PASSWD
    - sshpass -e scp -o StrictHostKeyChecking=no -r ./dist/* $PROD_SSH:~/$PROD_DIR
    - echo "Deployment complete"
  # specify environment this job is using
  environment:
    name: production
    url: "$PROD_URL"
  # only run on these branches
  only:
    - tags